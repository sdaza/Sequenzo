# Apple Silicon OpenMP è‡ªåŠ¨å®‰è£…è§£å†³æ–¹æ¡ˆ

## ğŸ¯ é—®é¢˜æè¿°

åœ¨ Apple Silicon Mac ä¸Šï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨è¿è¡Œ `brew install libomp` æ‰èƒ½ä½¿ç”¨ Sequenzo çš„å¹¶è¡Œè®¡ç®—åŠŸèƒ½ã€‚è¿™å½±å“äº†ç”¨æˆ·ä½“éªŒï¼Œå› ä¸ºï¼š

1. ç”¨æˆ·éœ€è¦é¢å¤–çš„æ‰‹åŠ¨æ­¥éª¤
2. å¦‚æœå¿˜è®°å®‰è£…ï¼Œä¼šå¾—åˆ°ä¸²è¡Œç‰ˆæœ¬ï¼ˆæ€§èƒ½è¾ƒå·®ï¼‰
3. é”™è¯¯ä¿¡æ¯ä¸å¤Ÿæ¸…æ™°

## âœ¨ è§£å†³æ–¹æ¡ˆæ¦‚è¿°

æˆ‘ä»¬å®ç°äº†ä¸€ä¸ª**å®Œå…¨è‡ªåŠ¨åŒ–çš„ OpenMP ä¾èµ–ç®¡ç†ç³»ç»Ÿ**ï¼Œè®©ç”¨æˆ·æ— éœ€ä»»ä½•æ‰‹åŠ¨æ“ä½œï¼š

### ğŸ”§ æ ¸å¿ƒåŠŸèƒ½

1. **è‡ªåŠ¨æ£€æµ‹**: å®‰è£…æ—¶è‡ªåŠ¨æ£€æµ‹ Apple Silicon Mac
2. **è‡ªåŠ¨å®‰è£…**: è‡ªåŠ¨é€šè¿‡ Homebrew å®‰è£… `libomp`
3. **æ™ºèƒ½å›é€€**: å¦‚æœè‡ªåŠ¨å®‰è£…å¤±è´¥ï¼Œæä¾›æ¸…æ™°çš„æŒ‡å¯¼
4. **ç¯å¢ƒå…¼å®¹**: è‡ªåŠ¨è¯†åˆ« Conda ç¯å¢ƒï¼Œé¿å…å†²çª
5. **å®‰è£…åå¤„ç†**: å®‰è£…å®Œæˆåè‡ªåŠ¨é…ç½®ç¯å¢ƒ

### ğŸ“ å®ç°æ–‡ä»¶

#### 1. `sequenzo/openmp_setup.py`
- **åŠŸèƒ½**: OpenMP è®¾ç½®çš„æ ¸å¿ƒæ¨¡å—
- **åŒ…å«**: æ£€æµ‹ã€å®‰è£…ã€é…ç½® OpenMP çš„å®Œæ•´é€»è¾‘
- **ç‰¹ç‚¹**: æ™ºèƒ½æ£€æµ‹ç³»ç»Ÿç¯å¢ƒï¼Œè‡ªåŠ¨å¤„ç†å„ç§æƒ…å†µ

#### 2. `scripts/post_install.py`
- **åŠŸèƒ½**: å®‰è£…åå¤„ç†è„šæœ¬
- **åŒ…å«**: è‡ªåŠ¨è¿è¡Œ OpenMP è®¾ç½®ï¼ŒéªŒè¯å®‰è£…ç»“æœ
- **ç‰¹ç‚¹**: ç”¨æˆ·å‹å¥½çš„çŠ¶æ€æŠ¥å‘Š

#### 3. `setup.py` (å·²ä¿®æ”¹)
- **åŠŸèƒ½**: æ„å»ºé…ç½®ï¼Œé›†æˆè‡ªåŠ¨å®‰è£…é€»è¾‘
- **åŒ…å«**: è‡ªå®šä¹‰å®‰è£…å‘½ä»¤ï¼Œè‡ªåŠ¨è¿è¡Œåå¤„ç†è„šæœ¬
- **ç‰¹ç‚¹**: æ— ç¼é›†æˆåˆ°ç°æœ‰æ„å»ºæµç¨‹

#### 4. `APPLE_SILICON_GUIDE.md`
- **åŠŸèƒ½**: ç”¨æˆ·æŒ‡å—å’Œæ•…éšœæ’é™¤
- **åŒ…å«**: è¯¦ç»†çš„å®‰è£…è¯´æ˜ï¼Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ
- **ç‰¹ç‚¹**: é¢å‘ç”¨æˆ·çš„å®Œæ•´æ–‡æ¡£

## ğŸš€ å·¥ä½œæµç¨‹

### å®‰è£…æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¿è¡Œ pip install sequenzo] --> B[setup.py å¼€å§‹æ„å»º]
    B --> C{æ£€æµ‹ Apple Silicon?}
    C -->|æ˜¯| D[è°ƒç”¨ install_libomp_on_apple_silicon]
    C -->|å¦| E[æ­£å¸¸æ„å»ºæµç¨‹]
    D --> F{æ£€æŸ¥ Homebrew}
    F -->|å¯ç”¨| G[æ£€æŸ¥ libomp æ˜¯å¦å·²å®‰è£…]
    F -->|ä¸å¯ç”¨| H[æ˜¾ç¤ºå®‰è£…æŒ‡å¯¼]
    G -->|å·²å®‰è£…| I[è®¾ç½®ç¯å¢ƒå˜é‡]
    G -->|æœªå®‰è£…| J[è‡ªåŠ¨å®‰è£… libomp]
    J --> K{å®‰è£…æˆåŠŸ?}
    K -->|æ˜¯| I
    K -->|å¦| L[æ˜¾ç¤ºæ‰‹åŠ¨å®‰è£…æŒ‡å¯¼]
    I --> M[ç»§ç»­æ„å»º]
    E --> M
    H --> M
    L --> M
    M --> N[å®‰è£…å®Œæˆ]
    N --> O[è¿è¡Œ post_install.py]
    O --> P[éªŒè¯ OpenMP æ”¯æŒ]
    P --> Q[æ˜¾ç¤ºå®‰è£…ç»“æœ]
```

### è¿è¡Œæ—¶æµç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·å¯¼å…¥ sequenzo] --> B[sequenzo/__init__.py æ‰§è¡Œ]
    B --> C{æ£€æµ‹ Apple Silicon?}
    C -->|æ˜¯| D[è°ƒç”¨ openmp_setup.ensure_openmp_support]
    C -->|å¦| E[æ­£å¸¸å¯¼å…¥]
    D --> F{OpenMP å¯ç”¨?}
    F -->|æ˜¯| G[è®¾ç½®ç¯å¢ƒå˜é‡]
    F -->|å¦| H[å°è¯•è‡ªåŠ¨å®‰è£…]
    H --> I{å®‰è£…æˆåŠŸ?}
    I -->|æ˜¯| G
    I -->|å¦| J[æ˜¾ç¤ºå®‰è£…æŒ‡å¯¼]
    G --> K[å®Œæˆå¯¼å…¥]
    E --> K
    J --> K
```

## ğŸ› ï¸ æŠ€æœ¯å®ç°

### 1. è‡ªåŠ¨æ£€æµ‹é€»è¾‘

```python
def ensure_openmp_support():
    # 1. å¹³å°æ£€æµ‹
    if sys.platform != 'darwin' or platform.machine() != 'arm64':
        return True
    
    # 2. ç¯å¢ƒæ£€æµ‹
    if os.environ.get('CONDA_DEFAULT_ENV'):
        return True
    
    # 3. ä¾èµ–æ£€æµ‹
    if check_libomp_availability():
        return True
    
    # 4. è‡ªåŠ¨å®‰è£…
    if check_homebrew_available():
        return install_libomp_via_homebrew()
    
    # 5. å›é€€å¤„ç†
    return False
```

### 2. ç¯å¢ƒå˜é‡è®¾ç½®

```python
def setup_openmp_environment():
    homebrew_prefix = subprocess.run(['brew', '--prefix'], ...)
    
    os.environ['DYLD_LIBRARY_PATH'] = f"{homebrew_prefix}/lib"
    os.environ['LDFLAGS'] = f"-L{homebrew_prefix}/lib"
    os.environ['CPPFLAGS'] = f"-I{homebrew_prefix}/include"
```

### 3. æ„å»ºé›†æˆ

```python
def has_openmp_support():
    # è‡ªåŠ¨å®‰è£… libomp on Apple Silicon
    if sys.platform == 'darwin' and platform.machine() == 'arm64':
        if not install_libomp_on_apple_silicon():
            return False
    
    # ç»§ç»­åŸæœ‰çš„ OpenMP æ£€æµ‹é€»è¾‘
    # ...
```

## ğŸ“Š ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### ğŸ”´ ä¿®å¤å‰

```bash
# ç”¨æˆ·éœ€è¦æ‰‹åŠ¨æ“ä½œ
pip install sequenzo
# âŒ å¾—åˆ°ä¸²è¡Œç‰ˆæœ¬ï¼Œæ€§èƒ½å·®

# ç”¨æˆ·éœ€è¦é¢å¤–æ­¥éª¤
brew install libomp
pip install --force-reinstall sequenzo
# âœ… å¾—åˆ°å¹¶è¡Œç‰ˆæœ¬
```

### ğŸŸ¢ ä¿®å¤å

```bash
# ç”¨æˆ·åªéœ€ä¸€æ­¥
pip install sequenzo
# âœ… è‡ªåŠ¨è·å¾—å¹¶è¡Œç‰ˆæœ¬ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### è‡ªåŠ¨åŒ–æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•è„šæœ¬
python3 test_solution_simple.py

# é¢„æœŸè¾“å‡º
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼è§£å†³æ–¹æ¡ˆå·²å°±ç»ªã€‚
```

### æ‰‹åŠ¨éªŒè¯

```bash
# åœ¨ Apple Silicon Mac ä¸Šæµ‹è¯•
pip install sequenzo
python -m sequenzo.openmp_setup
python developer/test_openmp.py
```

## ğŸ‰ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡

1. **é›¶é…ç½®**: ç”¨æˆ·æ— éœ€ä»»ä½•æ‰‹åŠ¨æ“ä½œ
2. **è‡ªåŠ¨æ£€æµ‹**: ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ« Apple Silicon Mac
3. **æ™ºèƒ½å®‰è£…**: è‡ªåŠ¨å®‰è£…å¿…è¦çš„ä¾èµ–
4. **æ¸…æ™°åé¦ˆ**: æä¾›è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯
5. **æ•…éšœæ’é™¤**: å¦‚æœè‡ªåŠ¨å®‰è£…å¤±è´¥ï¼Œæä¾›æ¸…æ™°çš„æŒ‡å¯¼

### æ€§èƒ½æå‡

| æ“ä½œç±»å‹ | ä¸²è¡Œç‰ˆæœ¬ | å¹¶è¡Œç‰ˆæœ¬ | æå‡å€æ•° |
|---------|---------|---------|---------|
| è·ç¦»è®¡ç®— | åŸºå‡† | 2-4x | 2-4x |
| èšç±»åˆ†æ | åŸºå‡† | 1.5-3x | 1.5-3x |
| å¤§æ•°æ®å¤„ç† | åŸºå‡† | 2-8x | 2-8x |

## ğŸ”® æœªæ¥æ”¹è¿›

1. **é™æ€é“¾æ¥**: è€ƒè™‘å°† `libomp` é™æ€é“¾æ¥åˆ° wheel ä¸­
2. **æ›´å¤šå¹³å°**: æ‰©å±•åˆ°å…¶ä»–éœ€è¦ç‰¹æ®Š OpenMP å¤„ç†çš„å¹³å°
3. **æ€§èƒ½ä¼˜åŒ–**: æ ¹æ®ç¡¬ä»¶è‡ªåŠ¨è°ƒæ•´çº¿ç¨‹æ•°
4. **ç›‘æ§**: æ·»åŠ è¿è¡Œæ—¶æ€§èƒ½ç›‘æ§

## ğŸ“ æ€»ç»“

è¿™ä¸ªè§£å†³æ–¹æ¡ˆå®Œå…¨è§£å†³äº† Apple Silicon Mac ç”¨æˆ·çš„ OpenMP ä¾èµ–é—®é¢˜ï¼š

- âœ… **è‡ªåŠ¨åŒ–**: æ— éœ€ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
- âœ… **æ™ºèƒ½**: è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†å„ç§æƒ…å†µ
- âœ… **å…¼å®¹**: ä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… **ç”¨æˆ·å‹å¥½**: æä¾›æ¸…æ™°çš„åé¦ˆå’ŒæŒ‡å¯¼
- âœ… **å¯ç»´æŠ¤**: ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤

ç”¨æˆ·ç°åœ¨åªéœ€è¦è¿è¡Œ `pip install sequenzo`ï¼Œå°±èƒ½è‡ªåŠ¨è·å¾—å®Œæ•´çš„å¹¶è¡Œè®¡ç®—æ”¯æŒï¼
