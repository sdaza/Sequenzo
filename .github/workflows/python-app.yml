# GitHub Actions workflow for Sequenzo package
# æ‰“åŒ… wheelï¼ˆ.whlï¼‰
# æ”¯æŒä¸‰å¤§å¹³å°ï¼š
# Linux (manylinux) â†’ ç”¨ cibuildwheel
# macOS (universal2) â†’ ç”¨ build_ext + build
# Windows â†’ ç”¨ cibuildwheel

name: Build Wheels for Sequenzo

on:
  push:
    tags:
      - "v*"  # æ¯”å¦‚ v0.1.0
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # å…¨å±€è®¾ç½®

jobs:
  build:
    name: Build ${{ matrix.os }} Py${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11']

    steps:
      - name: Checkout source with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      # ğŸš€ æ·»åŠ OpenMPæ”¯æŒ - ä¸ºé¢„ç¼–è¯‘wheelå¯ç”¨å¹¶è¡Œè®¡ç®—
      - name: Install OpenMP (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install libomp
          echo "CC=clang" >> $GITHUB_ENV
          echo "CXX=clang++" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix libomp)/lib" >> $GITHUB_ENV
          echo "CPPFLAGS=-I$(brew --prefix libomp)/include" >> $GITHUB_ENV
          echo "SEQUENZO_ENABLE_OPENMP=1" >> $GITHUB_ENV
          echo "âœ… macOS OpenMP (libomp) installed"

      - name: Install OpenMP (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libomp-dev
          echo "SEQUENZO_ENABLE_OPENMP=1" >> $GITHUB_ENV
          echo "âœ… Linux OpenMP (libomp-dev) installed"

      - name: Setup MSVC with OpenMP (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      
      - name: Enable OpenMP (Windows)
        if: runner.os == 'Windows'
        run: |
          echo "SEQUENZO_ENABLE_OPENMP=1" >> $env:GITHUB_ENV
          echo "âœ… Windows OpenMP (MSVC) enabled"

      # å®‰è£…ä¾èµ–æ—¶æŒ‡å®šä»…å®‰è£…å·²æœ‰ wheelï¼Œä¸æ„å»ºæºç åŒ…ï¼Œé˜²æ­¢ linux ç³»ç»Ÿé‡Œé¢ scipy é—®é¢˜
      # é¡¹ç›®ä¾èµ–äº† scipyï¼Œè€Œ scipy åœ¨ Linux ä¸Š ä»æºç æ„å»ºæ—¶ä¾èµ– OpenBLASï¼ˆæˆ– MKLï¼‰åº“ æ¥æ”¯æŒçŸ©é˜µ/çº¿æ€§ä»£æ•°åŠŸèƒ½ã€‚
      # ä½† GitHub Actions çš„åŸºç¡€é•œåƒé‡Œé»˜è®¤æ²¡è£… OpenBLAS å¼€å‘åº“ï¼Œæ‰€ä»¥æ„å»ºå¤±è´¥äº†ã€‚
      # è¿™é€šå¸¸å‘ç”Ÿåœ¨ æ„å»ºè½®å­çš„æ—¶å€™è‡ªåŠ¨è§¦å‘äº†æŸäº›ä¾èµ–ï¼ˆæ¯”å¦‚ scipyï¼‰ä»æºç ç¼–è¯‘ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨å·²æœ‰ wheelã€‚
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install --prefer-binary numpy scipy
          pip install --prefer-binary Cython pybind11 build cibuildwheel twine

      - name: Build Cython wheels on macOS
        if: runner.os == 'macOS'
        run: |
          python setup.py build_ext --inplace
          python -m build

      # åœ¨ Linux/windows æ„å»ºå¼€å§‹å‰ï¼ŒåŠ ä¸€æ­¥â€œå¹²å‡€åŒ–â€æ“ä½œ
      # åŠ ä¸Š shell: bash å°±èƒ½åœ¨ Windows ä¸Šä¹Ÿâ€œæ¨¡æ‹Ÿâ€å‡º Bash ç¯å¢ƒè¿è¡Œè¿™äº›å‘½ä»¤
      - name: Clean previous build outputs
        if: runner.os != 'macOS'
        run: |
          rm -rf build/ dist/ *.egg-info
          find . -name "*.so" -delete
        shell: bash

      # CIBW_SKIP: "pp*" è¡¨ç¤ºè·³è¿‡æ‰€æœ‰ PyPy æ„å»ºï¼ˆå¦‚ pp39-*, pp310-* ç­‰ï¼‰ã€‚
      # ä¸æ”¯æŒ 32-bit Windowsï¼šå‡ ä¹æ²¡äººç”¨äº†ã€å†…å­˜é™åˆ¶å¤ªä¸¥é‡ã€ç”Ÿæ€ç³»ç»Ÿæ­£åœ¨æ”¾å¼ƒã€PyPI ä¸Šä¼ å€¾å‘ 64-bit
      # æˆ‘ä»¬çš„é¡¹ç›®é‡Œæœ‰å¤§é‡çš„ Cython æ¨¡å—ã€.cpp / .pyx æ‰©å±•ã€pybind11 æ¥å£
      # è¿™äº›éƒ½æ˜¯ ä¸º CPython ç¼–è¯‘çš„æœ¬åœ°æ‰©å±•ï¼ŒPyPy å¯¹å®ƒä»¬æ”¯æŒå¾ˆä¸å®Œå–„ï¼Œç¼–è¯‘ä¹Ÿä¼šå¤±è´¥
      # Linux ä¹Ÿå¦‚æ­¤ï¼Œç¦æ­¢ä½¿ç”¨ 32-bitï¼Œå› ä¸ºä¸»æµ Linux å‘è¡Œç‰ˆï¼ˆUbuntu, Debian, CentOS ç­‰ï¼‰æ—©å·²é»˜è®¤å‘å¸ƒ 64-bit ç³»ç»Ÿã€‚
      - name: Build wheels with cibuildwheel
        if: runner.os != 'macOS'
        run: python -m cibuildwheel --output-dir dist
        env:
          CIBW_SKIP: "pp*"
          CIBW_ARCHS_WINDOWS: "AMD64"
          CIBW_ARCHS_LINUX: "x86_64"
          
          # ğŸš€ OpenMPç¯å¢ƒé…ç½®
          CIBW_ENVIRONMENT_LINUX: >
            SEQUENZO_ENABLE_OPENMP=1
          CIBW_ENVIRONMENT_WINDOWS: >
            SEQUENZO_ENABLE_OPENMP=1
          
          # Linux: å®‰è£…OpenMPå¼€å‘åº“
          CIBW_BEFORE_BUILD_LINUX: >
            yum install -y libgomp-devel ||
            apt-get update && apt-get install -y libomp-dev ||
            echo "OpenMP installation attempted"
          
          # æµ‹è¯•wheelæ˜¯å¦åŒ…å«OpenMP
          CIBW_TEST_COMMAND: >
            python -c "
            import sequenzo; 
            print('âœ… Sequenzo import successful');
            try:
              import sequenzo.clustering.clustering_c_code;
              print('âœ… C++ extensions loaded');
            except Exception as e:
              print(f'âš ï¸ C++ extensions issue: {e}')
            "

      - name: List wheel files (Linux/macOS only)
        if: runner.os != 'Windows'
        run: find dist/ -type f -name "*.whl" -print

      # è¿™æ ·å°±èƒ½çœ‹åˆ° actions æœºå™¨ä¸Šï¼Œ wheel æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
      # Windows çš„ bash ç¯å¢ƒä¸€æ ·æ”¯æŒ lsï¼Œå¹¶ä¸ä¼šæœ‰é—®é¢˜ã€‚è¿™æ ·æœ€ç®€æ´ã€æœ€å°‘å‘
      - name: Show dist content
        run: ls -lah dist/
        shell: bash

      # æ£€æŸ¥ .whl å’Œ .tar.gz æ˜¯å¦ç¬¦åˆ PyPI çš„æ ¼å¼è§„èŒƒï¼Œæå‰æ•è·æ‰“åŒ…é”™è¯¯ï¼Œé¿å…ä¸Šä¼  PyPI åæ‰å¤±è´¥
      - name: Check wheels
        run: twine check dist/*

      # ğŸ” éªŒè¯OpenMPæ”¯æŒ
      - name: Verify OpenMP Support
        run: |
          echo "=== éªŒè¯æ„å»ºçš„wheelä¸­çš„OpenMPæ”¯æŒ ==="
          python -c "
          import subprocess
          import sys
          import os
          
          # å®‰è£…åˆšæ„å»ºçš„wheel
          wheel_files = [f for f in os.listdir('dist') if f.endswith('.whl') and 'cp${{ matrix.python-version }}' in f.replace('.', '')]
          if wheel_files:
              wheel_file = wheel_files[0]
              print(f'ğŸ“¦ å®‰è£…wheel: {wheel_file}')
              subprocess.run([sys.executable, '-m', 'pip', 'install', '--force-reinstall', f'dist/{wheel_file}'], check=True)
              
              # æµ‹è¯•å¯¼å…¥
              import sequenzo
              print('âœ… Sequenzoå¯¼å…¥æˆåŠŸ')
              
              # æ£€æŸ¥C++æ‰©å±•
              try:
                  import sequenzo.clustering.clustering_c_code as cc
                  print('âœ… C++æ‰©å±•åŠ è½½æˆåŠŸ')
                  
                  # æ£€æŸ¥.so/.dll/.dylibæ–‡ä»¶çš„OpenMPé“¾æ¥
                  so_path = cc.__file__
                  print(f'ğŸ“„ æ£€æŸ¥æ–‡ä»¶: {so_path}')
                  
                  if sys.platform == 'darwin':
                      result = subprocess.run(['otool', '-L', so_path], capture_output=True, text=True)
                      if 'libomp' in result.stdout or 'libgomp' in result.stdout:
                          print('ğŸš€ âœ… OpenMPåº“é“¾æ¥æˆåŠŸ!')
                      else:
                          print('âš ï¸ æœªæ£€æµ‹åˆ°OpenMPåº“é“¾æ¥')
                          print('é“¾æ¥åº“:', result.stdout)
                  elif sys.platform.startswith('linux'):
                      result = subprocess.run(['ldd', so_path], capture_output=True, text=True)
                      if 'libgomp' in result.stdout or 'libomp' in result.stdout:
                          print('ğŸš€ âœ… OpenMPåº“é“¾æ¥æˆåŠŸ!')
                      else:
                          print('âš ï¸ æœªæ£€æµ‹åˆ°OpenMPåº“é“¾æ¥')
                          print('é“¾æ¥åº“:', result.stdout)
                  elif sys.platform == 'win32':
                      print('ğŸš€ âœ… Windows MSVC OpenMPæ”¯æŒå·²å¯ç”¨')
                      
              except ImportError as e:
                  print(f'âŒ C++æ‰©å±•åŠ è½½å¤±è´¥: {e}')
          else:
              print('âŒ æœªæ‰¾åˆ°å¯¹åº”çš„wheelæ–‡ä»¶')
          "
        shell: bash

      # æŠŠæ‰“å¥½çš„æ–‡ä»¶ä¸Šä¼ åˆ° GitHub Actions çš„ç•Œé¢ä¸­ï¼Œå¯ä»¥ä¾›æˆ‘ä»¬ä¸‹è½½
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.python-version }}
          path: dist/

